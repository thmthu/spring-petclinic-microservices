#!/usr/bin/env bash
# Pre-push hook to scan for secrets before pushing to remote
# This hook will be installed in .git/hooks/pre-push

set -e

echo "üîç Running Gitleaks scan before push..."
echo "========================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if gitleaks is installed
if ! command -v gitleaks &> /dev/null; then
    echo -e "${RED}‚ùå ERROR: Gitleaks is not installed!${NC}"
    echo ""
    echo "Please install gitleaks:"
    echo "  Windows (with Chocolatey): choco install gitleaks"
    echo "  Windows (with Scoop): scoop install gitleaks"
    echo "  macOS: brew install gitleaks"
    echo "  Linux: https://github.com/gitleaks/gitleaks#installing"
    echo ""
    exit 1
fi

# Get the remote and URL being pushed to
remote="$1"
url="$2"

echo "Remote: $remote"
echo "URL: $url"
echo ""

# Run gitleaks protect to scan commits that will be pushed
if gitleaks protect --verbose --redact --staged --config .gitleaks.toml; then
    echo ""
    echo -e "${GREEN}‚úÖ No secrets detected. Push allowed.${NC}"
    echo "========================================"
    exit 0
else
    echo ""
    echo -e "${RED}‚ùå SECRETS DETECTED! Push rejected.${NC}"
    echo "========================================"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Action required:${NC}"
    echo "1. Review the findings above"
    echo "2. Remove any hardcoded secrets from your code"
    echo "3. Use environment variables or secret management tools"
    echo "4. Commit the changes"
    echo "5. Try pushing again"
    echo ""
    echo "If this is a false positive, you can:"
    echo "  - Update .gitleaks.toml to allowlist specific patterns"
    echo "  - Use 'git push --no-verify' to bypass (NOT RECOMMENDED)"
    echo ""
    exit 1
fi
