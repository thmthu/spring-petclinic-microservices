#!/usr/bin/env bash
# Pre-commit hook to scan for secrets before committing
# This hook will be installed in .git/hooks/pre-commit

set -e

echo "üîç Running pre-commit checks..."
echo "========================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if gitleaks is installed
if ! command -v gitleaks &> /dev/null; then
    echo -e "${RED}‚ùå ERROR: Gitleaks is not installed!${NC}"
    echo ""
    echo "Please install gitleaks:"
    echo "  Windows (with Chocolatey): choco install gitleaks"
    echo "  Windows (with Scoop): scoop install gitleaks"
    echo "  macOS: brew install gitleaks"
    echo "  Linux: https://github.com/gitleaks/gitleaks#installing"
    echo ""
    exit 1
fi

# Run gitleaks on staged files
if gitleaks protect --verbose --redact --staged --config .gitleaks.toml; then
    echo ""
    echo -e "${GREEN}‚úÖ No secrets detected. Commit allowed.${NC}"
    echo "========================================"
    exit 0
else
    echo ""
    echo -e "${RED}‚ùå SECRETS DETECTED! Commit rejected.${NC}"
    echo "========================================"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Action required:${NC}"
    echo "1. Review the findings above"
    echo "2. Remove any hardcoded secrets from staged files"
    echo "3. Use environment variables or secret management tools"
    echo "4. Stage the corrected files"
    echo "5. Try committing again"
    echo ""
    echo "If this is a false positive, you can:"
    echo "  - Update .gitleaks.toml to allowlist specific patterns"
    echo "  - Use 'git commit --no-verify' to bypass (NOT RECOMMENDED)"
    echo ""
    exit 1
fi
